#!/usr/bin/env node
var Context = require('../index').Context;
var prompt = require('prompt');
var fs = require('fs');

var args = require('minimist')(process.argv.slice(2), {
  string: 'to',
  boolean: ['patch', 'minor', 'major', 'premajor', 'preminor', 'prepatch', 'prerelease', 'yes', 'quiet'],
  alias: { h: 'help', V: 'version', v: 'to', p: 'patch', m: 'minor', M: 'major', y: 'yes', q: 'quiet' }
});

if (args.help || !args._[0]) {
  var cmd = require('path').basename(process.argv[1]);
  console.log([
      'Usage:',
      '    '+cmd+' FILES [options]',
      '',
      'Options:',
      '    -h, --help         print usage information',
      '    -V, --version      show version info and exit',
      '',
      "    -y, --yes          assume yes, don't prompt",
      "    -q, --quiet        supress messages (implies -y)",
      '',
      '    -v, --to VERSION   use this version',
      '    -p, --patch        bump patch version (2.3.4 -> 2.3.5) - default',
      '    -m, --minor        bump minor version (2.3.4 -> 2.4.0)',
      '    -M, --major        bump major version (2.3.4 -> 3.0.0)',
      '',
      '        --prerelease   bump a prerelease number (2.3.4-8 -> 2.3.4-9)',
      '        --prepatch     bump patch and add prerelease (2.3.4 -> 2.3.5-0)',
      '        --preminor     bump minor and add prerelease (2.3.4 -> 2.4.0-0)',
      '        --premajor     bump major and add prerelease (2.3.4 -> 3.0.0-0)',
  ].join('\n'));
  process.exit();
}

if (args.version) {
  console.log(require('../package.json').version);
  process.exit();
}

try {
  var contexts = [];
  var options = toOptions(args);

  args._.forEach(function (fname) {
    var contents = require('fs').readFileSync(fname, 'utf-8');
    var ctx = new Context(contents, fname, options);
    if (!ctx.valid) { throw new Error("ENOVERSION, no version found on '" + fname + "'"); }
    contexts.push(ctx);
  });

  contexts.forEach(function (ctx) {
    print(ctx.preview());
    print();
  });

  askToProceed(function (res) {
    if (res) {
      contexts.forEach(function (ctx) {
        fs.writeFileSync(ctx.filename, ctx.toString(), 'utf-8');
      });
      print('\033[1A\033[2K\033[32m✓\033[0m', 'done!');
    } else {
      print('\033[1A\033[2K\033[31m✗\033[0m', 'cancelled');
    }
  });

} catch (e) {
  console.warn('\033[31m✗\033[0m', e.message);
  process.exit(8);
}

function print () {
  if (args.quiet) return;
  console.warn.apply(console, arguments);
}

function askToProceed (fn) {
  if (args.yes || args.quiet) return fn(true);
  ask('proceed? [Yn] ', function (res) {
    if (res.toLowerCase() === 'y' || !res)
      fn(true);
    else
      fn(false);
  });
}

/**
 * toOptions():
 * (private)
 */

function toOptions (args) {
  var options = {};

  if (args.to) options.version = args.to;
  else if (args.major) options.inc = 'major';
  else if (args.minor) options.inc = 'minor';
  else if (args.premajor) options.inc = 'premajor';
  else if (args.preminor) options.inc = 'preminor';
  else if (args.prepatch) options.inc = 'prepatch';
  else if (args.prerelease) options.inc = 'prerelease';
  else options.inc = 'patch';

  return options;
}

/**
 * ask():
 * (private) thanks https://coderwall.com/p/v16yja
 */

function ask (question, fn) {
  var r = require('readline').createInterface({
    input: process.stdin,
    output: process.stderr});

  r.question(question, function (answer) {
    r.close();
    fn(answer);
  });
}
